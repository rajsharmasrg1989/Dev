  pipeline {
    agent any
    
    stages {
        stage('Checkout Code') {
            steps {
                // Check out the code from the GitHub repository to the workspace
                 git url: 'https://github.com/rajsharmasrg1989/Dev.git', branch: 'main'
            }
        }
        
        stage('Process YAML Files and Create CSV') {
            steps {
                script {
                    def csvRows = [['Cluster', 'Region']] // Initialize CSV header row
                    
                    // Find all YAML files in the 'configs' directory (adjust path as needed)
                    def yamlFiles = findFiles(glob: 'configs/*.yml')
                    
                    if (yamlFiles.length > 0) {
                        for (def file : yamlFiles) {
                            // Read and parse the YAML file content
                            def config = readYaml file: file.path
                            
                            // Extract cluster and region details
                            def clusterName = config?.cluster
                            def regionName = config?.region
                            
                            // Add details to the CSV rows if found
                            if (clusterName && regionName) {
                                csvRows.add([clusterName, regionName])
                                echo "Found Cluster: ${clusterName}, Region: ${regionName}"
                            } else {
                                echo "Warning: Could not find 'cluster' or 'region' in ${file.path}"
                            }
                        }
                        
                        // Define the output CSV file path
                        def csvFilePath = "${WORKSPACE}/output_details.csv"
                        
                        // Write the collected data to a CSV file in the workspace
                        writeCSV file: csvFilePath, records: csvRows
                        echo "Successfully created CSV file at ${csvFilePath}"
                    } else {
                        echo "No YAML files found in the specified directory."
                    }
                }
            }
        }
    }
    post {
        always {
            // Archive the generated CSV file for easy access from the Jenkins UI
            archiveArtifacts artifacts: 'output_details.csv', onlyIfSuccessful: true
        }
    }
}
